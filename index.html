<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Retro Birthday Gift</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>tailwind.config={theme:{extend:{colors:{primary:'#4ade80',secondary:'#f87171'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" />
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        @keyframes blink {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }

        @keyframes scanline {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(100%);
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pixelate {
            0% {
                filter: blur(0px);
            }
            50% {
                filter: blur(1px);
            }
            100% {
                filter: blur(0px);
            }
        }

        @keyframes typewriter {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 8s linear infinite;
            pointer-events: none;
            z-index: 10;
        }

        .crt-effect {
            position: relative;
            overflow: hidden;
        }

        .crt-effect::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 5;
        }

        .pixel-font {
            font-family: 'Press Start 2P', cursive;
            letter-spacing: 1px;
        }

        .btn-retro {
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }

        .btn-retro:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.3);
        }

        .btn-retro:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .d-pad {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .d-pad-button {
            position: absolute;
            background-color: #1f2937;
            transition: all 0.1s ease;
        }

        .d-pad-up,
        .d-pad-down {
            width: 30%;
            height: 40%;
            left: 35%;
        }

        .d-pad-left,
        .d-pad-right {
            width: 40%;
            height: 30%;
            top: 35%;
        }

        .d-pad-up {
            top: 0;
            border-radius: 4px 4px 0 0;
        }

        .d-pad-right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        .d-pad-down {
            bottom: 0;
            border-radius: 0 0 4px 4px;
        }

        .d-pad-left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }

        .d-pad-center {
            position: absolute;
            width: 30%;
            height: 30%;
            top: 35%;
            left: 35%;
            background-color: #374151;
        }

        .action-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease;
            cursor: pointer;
        }

        .action-button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
        }

        .action-button:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .cursor-blink {
            animation: blink 1s step-end infinite;
        }

        .typewriter {
            overflow: hidden;
            white-space: nowrap;
            border-right: 0.15em solid #4ade80;
            animation: typewriter 3.5s steps(40, end), blink 0.75s step-end infinite;
        }

        .photo-slide {
            animation: slideDown 0.5s ease-out forwards;
        }

        .screen {
            background-color: #0a2a12;
            border: 8px solid #1a1a1a;
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.2);
        }

        .console-body {
            background-color: #f0f0f0;
            border-radius: 16px;
            box-shadow:
                0 10px 25px rgba(0, 0, 0, 0.2),
                inset 0 -5px 10px rgba(0, 0, 0, 0.1),
                inset 0 5px 10px rgba(255, 255, 255, 0.8);
        }

        .hidden {
            display: none;
        }
        /* Additional styles for Tetris cells */
        #tetrisScreen .grid > div {
            background-color: #111827; /* Darker cell background */
            border-radius: 2px;
            box-shadow: inset 0 0 3px rgba(0,0,0,0.7);
            transition: background-color 0.2s ease;
        }
        #tetrisScreen .grid > div.filled {
            box-shadow:
                inset 0 0 5px #4ade80,
                0 0 10px #4ade80;
        }

        #tetrisScreen .grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px; /* opsional */
            overflow: hidden;
            aspect-ratio: 10 / 20;
        }
        .tetris-cell {
            background-color: #111827;
            border-radius: 2px;
            box-shadow: inset 0 0 3px rgba(0,0,0,0.7);
            transition: background-color 0.2s ease;
        }
        .tetris-cell.filled {
            box-shadow: inset 0 0 5px #4ade80, 0 0 10px #4ade80;
        }

    </style>
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center p-4 font-['Press_Start_2P']">
    <div class="console-body w-full max-w-md p-6 relative">
        <!-- Console Header -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
                <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                <span class="text-xs text-gray-700">POWER</span>
            </div>
            <div class="text-xs text-gray-700">Punya-Asraf</div>
        </div>

        <!-- Main Screen -->
        <div class="screen crt-effect w-full aspect-[4/3] mb-6 p-4 relative" id="mainScreen">
            <div class="scanline"></div>

            <!-- Home Screen (Default) -->
            <div id="homeScreen" class="h-full flex flex-col justify-center items-center">
                <h1 class="text-primary text-2xl mb-6 text-center">Happy Birthday ADHWAAAAA!</h1>
                <p class="text-yellow-300 text-sm animate-pulse">Press Start Button</p>
                <div class="text-xs text-gray-500 absolute bottom-2 left-0 right-0 text-center">DOT MATRIX WITH STEREO SOUND</div>
            </div>

            <!-- Message Screen -->
            <div id="messageScreen" class="h-full flex flex-col justify-start items-center pt-4 hidden">
                <div class="typewriter text-primary text-sm mb-4 w-full text-[8px]">Selamat Ulang Tahun Adhwa!!</div>
                <div class="text-primary text-xs mt-4 overflow-y-auto h-full">
                    <p class="mb-2">Hari ini adalah hari spesial kamu jadi aku buat ini untuk kamu!</p>
                    <p class="mb-2">Semoga bertambahnya umur kamu dapat membawa kebahagiaan dan kesuksesan, tapi ga membawa taehyung xixixi.</p>
                    <p class="mb-2">Terima kasih telah menjadi orang yang luar biasa untuk aku.</p>
                    <p class="mb-4">Nikmati hadiah kecil ini yaa, aku buat game untuk kamu!</p>
                    <p class="text-yellow-300">Tekan B untuk kembali</p>
                </div>
            </div>

            <!-- Gallery Screen -->
            <div id="galleryScreen" class="h-full flex flex-col justify-center items-center hidden">
                <div class="relative w-full h-full flex items-center justify-center">
                    <div class="photo-container w-5/6 h-5/6 border-4 border-gray-700 relative overflow-hidden">
                        <div class="photo photo-slide absolute inset-0 bg-gray-800 flex items-center justify-center" data-index="0">
                            <p class="text-primary text-xs text-center">gapunya foto kamu</p>
                        </div>
                        <div class="photo hidden absolute inset-0 bg-gray-800 flex items-center justify-center" data-index="1">
                            <p class="text-primary text-xs text-center">kamu bilang impossible</p>
                        </div>
                        <div class="photo hidden absolute inset-0 bg-gray-800 flex items-center justify-center" data-index="2">
                            <p class="text-primary text-xs text-center">aku hapus aja kali ya untuk menu gallery??</p>
                        </div>
                        <div class="photo hidden absolute inset-0 bg-gray-800 flex items-center justify-center" data-index="2">
                            <p class="text-primary text-xs text-center">atau foto monyet aja mau hehehe</p>
                        </div>
                    </div>
                    <div class="absolute bottom-2 right-2 text-primary text-xs">1/4</div>
                </div>
                <p class="text-yellow-300 text-xs absolute bottom-2 left-0 right-0 text-center">← → untuk navigasi</p>
            </div>

            <!-- Music Screen -->
            <div id="musicScreen" class="h-full flex flex-col justify-start items-center pt-4 hidden">
                <h2 class="text-primary text-sm mb-6">Playlist kesukaan kamu</h2>
                <div class="w-full overflow-y-auto max-h-48">
                    <div class="track flex justify-between items-center p-2 mb-2 border border-primary cursor-pointer" data-src="Lana Del Rey - Brooklyn Baby (Official Audio).mp3">
                        <span class="text-primary text-xs">1. Lana Del Rey - Brooklyn Baby</span>
                        <div class="w-4 h-4 flex items-center justify-center play-button">
                            <i class="ri-play-fill text-primary"></i>
                        </div>
                    </div>
                    <div class="track flex justify-between items-center p-2 mb-2 cursor-pointer" data-src="No. 1 Party Anthem.mp3">
                        <span class="text-primary text-xs">2. Artic Monkey - No. 1 Party Anthem</span>
                        <div class="w-4 h-4 flex items-center justify-center play-button">
                            <i class="ri-play-fill text-primary"></i>
                        </div>
                    </div>
                    <div class="track flex justify-between items-center cursor-pointer p-2 mb-2" data-src="PUBLIC - Make You Mine (Put Your Hand in Mine) [Official Video].mp3">
                        <span class="text-primary text-xs">3. PUBLIC - Make You Mine</span>
                        <div class="w-4 h-4 flex items-center justify-center play-button">
                            <i class="ri-play-fill text-primary"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-4 w-full flex justify-center">
                    <div class="controls flex space-x-4">
                        <div class="w-6 h-6 flex items-center justify-center cursor-pointer" id="prevBtn" title="Previous Track">
                            <i class="ri-skip-back-fill text-primary"></i>
                        </div>
                        <div class="w-6 h-6 flex items-center justify-center cursor-pointer" id="playPauseBtn" title="Play/Pause">
                            <i class="ri-play-fill text-primary"></i>
                        </div>
                        <div class="w-6 h-6 flex items-center justify-center cursor-pointer" id="nextBtn" title="Next Track">
                            <i class="ri-skip-forward-fill text-primary"></i>
                        </div>
                    </div>
                </div>
                <p class="text-yellow-300 text-xs absolute bottom-2 left-0 right-0 text-center">Tekan B untuk kembali</p>
            </div>

            <!-- Tetris Screen -->
            <div id="tetrisScreen" class="h-full flex flex-col justify-center items-center hidden relative">
                <h2 class="text-primary text-sm mb-2">TETRIS</h2>
                <div class="grid grid-cols-10 gap-1 w-4/5 h-4/5 border-2 border-primary p-1 relative" style="position:relative;">
                    <!-- Tetris grid will be generated by JS -->
                </div>
                <p class="text-yellow-300 text-xs absolute bottom-2 left-0 right-0 text-center">Tekan START untuk mulai</p>
                <p class="text-yellow-300 text-xs absolute top-6 left-0 right-0 text-center hidden" id="scoreDisplay">Score: 0</p>
                <p class="text-yellow-300 text-xs absolute top-12 left-0 right-0 text-center hidden" id="gameOverDisplay">Game Over! Main lagi ga? tekan START</p>
            </div>

            <div class="absolute bottom-0 right-2 flex items-center">
                <div class="w-2 h-2 bg-red-500 rounded-full mr-1"></div>
                <span class="text-[8px] text-gray-500">BATTERY</span>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="flex flex-col space-y-4">
            <!-- Menu Buttons -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button class="btn-retro bg-blue-500 text-white py-3 !rounded-button text-sm" id="messageBtn">MESSAGE</button>
                <button class="btn-retro bg-red-500 text-white py-3 !rounded-button text-sm" id="galleryBtn">GALLERY</button>
                <button class="btn-retro bg-purple-500 text-white py-3 !rounded-button text-sm" id="musicBtn">MUSIC</button>
                <button class="btn-retro bg-green-500 text-white py-3 !rounded-button text-sm" id="tetrisBtn">TETRIS</button>
            </div>

            <!-- Game Controls -->
            <div class="flex justify-between items-center">
                <!-- D-Pad -->
                <div class="d-pad">
                    <div class="d-pad-up d-pad-button"></div>
                    <div class="d-pad-right d-pad-button"></div>
                    <div class="d-pad-down d-pad-button"></div>
                    <div class="d-pad-left d-pad-button"></div>
                    <div class="d-pad-center"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-4">
                    <div class="action-button bg-red-500 text-white cursor-pointer">B</div>
                    <div class="action-button bg-red-500 text-white cursor-pointer">A</div>
                </div>
            </div>

            <!-- System Buttons -->
            <div class="flex justify-center space-x-8 mt-2">
                <button class="bg-gray-700 text-white text-xs py-1 px-4 !rounded-button" id="selectBtn">SELECT</button>
                <button class="bg-gray-700 text-white text-xs py-1 px-4 !rounded-button" id="startBtn">START</button>
            </div>

            <!-- Speaker -->
            <div class="flex justify-end">
                <div class="grid grid-cols-3 gap-1">
                    <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                </div>
            </div>
        </div>
    </div>

    <script id="audioEffects">
        // Audio effects
        function createAudio(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            if (type === 'button') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } else if (type === 'select') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(660, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.15);
            }
        }
    </script>
    <script id="screenManager">
        document.addEventListener('DOMContentLoaded', function () {
            // Screen elements
            const screens = {
                home: document.getElementById('homeScreen'),
                message: document.getElementById('messageScreen'),
                gallery: document.getElementById('galleryScreen'),
                music: document.getElementById('musicScreen'),
                tetris: document.getElementById('tetrisScreen'),
            };

            // Button elements
            const buttons = {
                message: document.getElementById('messageBtn'),
                gallery: document.getElementById('galleryBtn'),
                music: document.getElementById('musicBtn'),
                tetris: document.getElementById('tetrisBtn'),
                start: document.getElementById('startBtn'),
                select: document.getElementById('selectBtn'),
            };

            // D-Pad elements
            const dPad = {
                up: document.querySelector('.d-pad-up'),
                right: document.querySelector('.d-pad-right'),
                down: document.querySelector('.d-pad-down'),
                left: document.querySelector('.d-pad-left'),
            };

            // Action buttons
            const actionButtons = {
                a: document.querySelectorAll('.action-button')[1],
                b: document.querySelectorAll('.action-button')[0],
            };

            // Current active screen
            let currentScreen = 'home';

            // Audio playback for music screen
            let audio = new Audio();
            let currentTrackIndex = null;
            const tracks = Array.from(document.querySelectorAll('#musicScreen .track'));
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            function playTrack(index) {
                if (index < 0) index = tracks.length - 1;
                if (index >= tracks.length) index = 0;
                const track = tracks[index];

                if (!track) return;

                if (currentTrackIndex !== index) {
                    currentTrackIndex = index;
                    audio.src = track.getAttribute('data-src');
                    audio.play();
                    updatePlayPauseIcon(true);
                    highlightCurrentTrack();
                } else if (audio.paused) {
                    audio.play();
                    updatePlayPauseIcon(true);
                } else {
                    audio.pause();
                    updatePlayPauseIcon(false);
                }
            }

            function highlightCurrentTrack() {
                tracks.forEach((t, i) => {
                    if (i === currentTrackIndex) {
                        t.classList.add('border-primary');
                        t.classList.add('bg-gray-800');
                    } else {
                        t.classList.remove('border-primary');
                        t.classList.remove('bg-gray-800');
                    }
                });
            }

            function updatePlayPauseIcon(isPlaying) {
                if (isPlaying) {
                    playPauseBtn.innerHTML = '<i class="ri-pause-fill text-primary"></i>';
                } else {
                    playPauseBtn.innerHTML = '<i class="ri-play-fill text-primary"></i>';
                }
            }

            // Play/pause button handler
            playPauseBtn.addEventListener('click', () => {
                if (currentTrackIndex === null) {
                    playTrack(0);
                } else if (audio.paused) {
                    audio.play();
                    updatePlayPauseIcon(true);
                } else {
                    audio.pause();
                    updatePlayPauseIcon(false);
                }
                createAudio('button');
            });

            // Previous button handler
            prevBtn.addEventListener('click', () => {
                if (currentTrackIndex === null) {
                    playTrack(0);
                } else {
                    playTrack(currentTrackIndex - 1);
                }
                createAudio('button');
            });

            // Next button handler
            nextBtn.addEventListener('click', () => {
                if (currentTrackIndex === null) {
                    playTrack(0);
                } else {
                    playTrack(currentTrackIndex + 1);
                }
                createAudio('button');
            });

            // Track click handlers
            tracks.forEach((track, index) => {
                track.addEventListener('click', () => {
                    playTrack(index);
                    createAudio('button');
                });
            });

            // Pause audio when switching screen away from music
            function stopAudioOnScreenChange(newScreen) {
                if (newScreen !== 'music' && !audio.paused) {
                    audio.pause();
                    updatePlayPauseIcon(false);
                    currentTrackIndex = null;
                    highlightCurrentTrack();
                }
            }

            // Show a specific screen
            function showScreen(screenName) {
                // Hide all screens
                Object.values(screens).forEach((screen) => {
                    screen.classList.add('hidden');
                });

                // Stop audio if leaving music screen
                stopAudioOnScreenChange(screenName);

                // Show the requested screen
                screens[screenName].classList.remove('hidden');
                currentScreen = screenName;

                // Add pixelate animation
                document.getElementById('mainScreen').classList.add('animate-pixelate');
                setTimeout(() => {
                    document.getElementById('mainScreen').classList.remove('animate-pixelate');
                }, 300);

                // Play sound effect
                createAudio('select');
            }

            // Button click handlers
            buttons.message.addEventListener('click', () => showScreen('message'));
            buttons.gallery.addEventListener('click', () => showScreen('gallery'));
            buttons.music.addEventListener('click', () => showScreen('music'));
            buttons.tetris.addEventListener('click', () => showScreen('tetris'));
            buttons.start.addEventListener('click', () => {
                if (currentScreen === 'home') {
                    showScreen('message');
                } else if (currentScreen === 'tetris') {
                    // Start Tetris game
                    initTetris();
                }
                createAudio('button');
            });

            // Action button handlers
            actionButtons.b.addEventListener('click', () => {
                if (currentScreen !== 'home') {
                    showScreen('home');
                }
                // Stop audio when returning home
                if (currentScreen === 'music' && !audio.paused) {
                    audio.pause();
                    updatePlayPauseIcon(false);
                    currentTrackIndex = null;
                    highlightCurrentTrack();
                }
                createAudio('button');
            });

            // Add hover effects to all buttons
            const allButtons = [...Object.values(buttons), ...Object.values(actionButtons)];
            allButtons.forEach((button) => {
                button.addEventListener('mousedown', () => {
                    createAudio('button');
                });
            });

            // D-Pad navigation for gallery
            let currentPhotoIndex = 0;
            const photos = document.querySelectorAll('.photo');
            const photoCounter = document.querySelector('#galleryScreen .text-xs.absolute');

            function updateGallery() {
                // Hide all photos
                photos.forEach((photo) => photo.classList.add('hidden'));

                // Show current photo
                photos[currentPhotoIndex].classList.remove('hidden');
                photos[currentPhotoIndex].classList.add('photo-slide');

                // Update counter
                photoCounter.textContent = `${currentPhotoIndex + 1}/${photos.length}`;

                createAudio('button');
            }

            dPad.left.addEventListener('click', () => {
                if (currentScreen === 'gallery') {
                    currentPhotoIndex = (currentPhotoIndex - 1 + photos.length) % photos.length;
                    updateGallery();
                }
            });

            dPad.right.addEventListener('click', () => {
                if (currentScreen === 'gallery') {
                    currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
                    updateGallery();
                }
            });

            dPad.down.addEventListener('click', () => {
                if (currentScreen !== 'home') {
                    showScreen('home');
                }
            });

            // Initialize the gallery when it's first shown
            buttons.gallery.addEventListener('click', () => {
                setTimeout(updateGallery, 100);
            });
        });
    </script>

    <script id="tetrisGame">
        // Tetris Game Implementation
        document.addEventListener('DOMContentLoaded', () => {
            const tetrisScreen = document.getElementById('tetrisScreen');
            const grid = tetrisScreen.querySelector('.grid');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const gameOverDisplay = document.getElementById('gameOverDisplay');

            const COLS = 10;
            const ROWS = 7;
            const BLOCK_SIZE = 100 / COLS + '%'; // pakai persentase agar fleksibel
            let gridCells = [];

            // Create grid cells
            function createGrid() {
                grid.innerHTML = '';
                gridCells = [];
                for (let i = 0; i < ROWS * COLS; i++) {
                    const cell = document.createElement('div');
                    cell.style.width = '100%';
                    cell.style.aspectRatio = '1 / 1'; // menjaga persegi
                    cell.classList.add('tetris-cell');
                    grid.appendChild(cell);
                    gridCells.push(cell);
                }
            }


            // Tetromino shapes and colors
            const tetrominoes = [
                // I
                { shape: [[1,1,1,1]], color: '#22c55e' },
                // J
                { shape: [[1,0,0],[1,1,1]], color: '#2563eb' },
                // L
                { shape: [[0,0,1],[1,1,1]], color: '#f97316' },
                // O
                { shape: [[1,1],[1,1]], color: '#eab308' },
                // S
                { shape: [[0,1,1],[1,1,0]], color: '#84cc16' },
                // T
                { shape: [[0,1,0],[1,1,1]], color: '#a855f7' },
                // Z
                { shape: [[1,1,0],[0,1,1]], color: '#dc2626' },
            ];

            // Rotate matrix clockwise
            function rotate(shape) {
                const rows = shape.length;
                const cols = shape[0].length;
                const rotated = [];
                for (let c = 0; c < cols; c++) {
                    const newRow = [];
                    for (let r = rows - 1; r >= 0; r--) {
                        newRow.push(shape[r][c]);
                    }
                    rotated.push(newRow);
                }
                return rotated;
            }

            // Check collision of tetromino with board or other blocks
            function collide(board, shape, pos) {
                for (let y = 0; y < shape.length; y++) {
                    for (let x = 0; x < shape[y].length; x++) {
                        if (shape[y][x]) {
                            let boardX = pos.x + x;
                            let boardY = pos.y + y;
                            if (
                                boardX < 0 || boardX >= COLS ||
                                boardY >= ROWS ||
                                (boardY >= 0 && board[boardY][boardX] !== 0)
                            ) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            // Draw everything on the grid
            function drawGrid(board, current) {
                // Clear grid
                for(let i=0; i<gridCells.length; i++) {
                    gridCells[i].style.backgroundColor = '#111827';
                    gridCells[i].classList.remove('filled');
                }

                // Draw placed blocks
                for (let y = 0; y < ROWS; y++) {
                    for (let x = 0; x < COLS; x++) {
                        const val = board[y][x];
                        if (val !== 0) {
                            const idx = y * COLS + x;
                            gridCells[idx].style.backgroundColor = val;
                            gridCells[idx].classList.add('filled');
                        }
                    }
                }

                // Draw current tetromino
                if (current) {
                    const shape = current.shape;
                    for (let y = 0; y < shape.length; y++) {
                        for (let x = 0; x < shape[y].length; x++) {
                            if (shape[y][x]) {
                                let gx = current.pos.x + x;
                                let gy = current.pos.y + y;
                                if (gy >= 0) {
                                    let idx = gy * COLS + gx;
                                    if(idx >= 0 && idx < gridCells.length){
                                        gridCells[idx].style.backgroundColor = current.color;
                                        gridCells[idx].classList.add('filled');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Clear full lines and return count
            function clearLines(board) {
                let linesCleared = 0;
                for(let y = ROWS - 1; y >= 0; y--) {
                    if (board[y].every(cell => cell !== 0)) {
                        board.splice(y,1);
                        board.unshift(new Array(COLS).fill(0));
                        linesCleared++;
                        y++; // recheck this row after shifting
                    }
                }
                return linesCleared;
            }

            // Create blank board
            function createBoard() {
                return Array.from({length: ROWS}, () => new Array(COLS).fill(0));
            }

            // Game state
            let board = createBoard();
            let currentTetromino = null;
            let dropCounter = 0;
            let dropInterval = 700;
            let lastTime = 0;
            let score = 0;
            let gameOver = false;

            function updateScore(lines) {
                const points = lines * 100;
                score += points;
                scoreDisplay.textContent = 'Score: ' + score;
            }

            // Set current piece
            function newTetromino() {
                const r = Math.floor(Math.random() * tetrominoes.length);
                const tet = JSON.parse(JSON.stringify(tetrominoes[r]));
                return {
                    shape: tet.shape,
                    color: tet.color,
                    pos: {x: Math.floor(COLS / 2) - Math.floor(tet.shape[0].length / 2), y: 0}
                };
            }

            // Merge current piece to board
            function merge(board, tet) {
                for(let y=0; y < tet.shape.length; y++){
                    for(let x=0; x < tet.shape[y].length; x++){
                        if (tet.shape[y][x]) {
                            let by = tet.pos.y + y;
                            let bx = tet.pos.x + x;
                            if(by >= 0 && by < ROWS && bx >=0 && bx < COLS){
                                board[by][bx] = tet.color;
                            }
                        }
                    }
                }
            }

            // Drop the piece one cell down
            function drop() {
                if (gameOver) return;
                currentTetromino.pos.y++;
                if(collide(board, currentTetromino.shape, currentTetromino.pos)){
                    currentTetromino.pos.y--;
                    merge(board, currentTetromino);
                    const linesCleared = clearLines(board);
                    if(linesCleared > 0) updateScore(linesCleared);
                    currentTetromino = newTetromino();
                    if(collide(board, currentTetromino.shape, currentTetromino.pos)){
                        // Game Over
                        gameOver = true;
                        gameOverDisplay.classList.remove('hidden');
                        scoreDisplay.classList.add('hidden');
                    }
                }
                drawGrid(board, currentTetromino);
            }

            // Move piece left or right
            function move(dir) {
                if (gameOver) return;
                currentTetromino.pos.x += dir;
                if(collide(board, currentTetromino.shape, currentTetromino.pos)) {
                    currentTetromino.pos.x -= dir;
                } else {
                    drawGrid(board, currentTetromino);
                }
            }

            // Rotate piece with collision and wall kick
            function rotateTetromino() {
                if (gameOver) return;
                const rotatedShape = rotate(currentTetromino.shape);
                const pos = currentTetromino.pos;
                // Try rotations with kicks
                let kicks = [0, -1, 1, -2, 2];
                let rotated = null;
                for(let kick of kicks){
                    const newPos = {x: pos.x + kick, y: pos.y};
                    if(!collide(board, rotatedShape, newPos)){
                        rotated = rotatedShape;
                        currentTetromino.pos.x = newPos.x;
                        break;
                    }
                }
                if(rotated){
                    currentTetromino.shape = rotated;
                    drawGrid(board, currentTetromino);
                }
            }

            // Hard drop (move down until collision)
            function hardDrop() {
                if(gameOver) return;
                while(!collide(board, currentTetromino.shape, {x: currentTetromino.pos.x, y: currentTetromino.pos.y + 1})){
                    currentTetromino.pos.y++;
                }
                drop();
            }

            function gameLoop(time = 0){
                if(gameOver) return;
                const deltaTime = time - lastTime;
                lastTime = time;
                dropCounter += deltaTime;
                if(dropCounter > dropInterval){
                    drop();
                    dropCounter = 0;
                }
                requestAnimationFrame(gameLoop);
            }

            // Initialize grid
            createGrid();

            // Game controls bindings
            function resetGame() {
                board = createBoard();
                currentTetromino = newTetromino();
                dropCounter = 0;
                lastTime = 0;
                score = 0;
                gameOver = false;
                scoreDisplay.textContent = 'Score: 0';
                scoreDisplay.classList.remove('hidden');
                gameOverDisplay.classList.add('hidden');
                drawGrid(board, currentTetromino);
                requestAnimationFrame(gameLoop);
            }

            // Expose init function globally to be called on start button press
            window.initTetris = resetGame;

            // Keyboard controls
            window.addEventListener('keydown', (e) => {
                if(document.getElementById('tetrisScreen').classList.contains('hidden')) return; // Only active when tetris screen visible
                if(gameOver && e.key !== 'Enter' && e.key !== ' ') return;

                switch(e.key){
                    case 'ArrowLeft':
                        e.preventDefault();
                        move(-1);
                        createAudio('button');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        move(1);
                        createAudio('button');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        drop();
                        createAudio('button');
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        rotateTetromino();
                        createAudio('button');
                        break;
                    case ' ':
                    case 'Enter':
                        e.preventDefault();
                        if(gameOver){
                            resetGame();
                            createAudio('select');
                        } else {
                            hardDrop();
                            createAudio('button');
                        }
                        break;
                    case 'b':
                    case 'B':
                        // Back to home screen
                        document.getElementById('homeScreen').classList.remove('hidden');
                        document.getElementById('tetrisScreen').classList.add('hidden');
                        createAudio('button');
                        break;
                }
            });

            // D-pad and buttons control mapping for tetris
            const dPadUp = document.querySelector('.d-pad-up');
            const dPadDown = document.querySelector('.d-pad-down');
            const dPadLeft = document.querySelector('.d-pad-left');
            const dPadRight = document.querySelector('.d-pad-right');
            const buttonA = document.querySelectorAll('.action-button')[1];
            const buttonB = document.querySelectorAll('.action-button')[0];

            dPadLeft.addEventListener('click', () => {
                if (document.getElementById('tetrisScreen').classList.contains('hidden')) return;
                move(-1);
                createAudio('button');
            });
            dPadRight.addEventListener('click', () => {
                if (document.getElementById('tetrisScreen').classList.contains('hidden')) return;
                move(1);
                createAudio('button');
            });
            dPadDown.addEventListener('click', () => {
                if (document.getElementById('tetrisScreen').classList.contains('hidden')) return;
                drop();
                createAudio('button');
            });
            dPadUp.addEventListener('click', () => {
                if (document.getElementById('tetrisScreen').classList.contains('hidden')) return;
                rotateTetromino();
                createAudio('button');
            });
            buttonA.addEventListener('click', () => {
                if (document.getElementById('tetrisScreen').classList.contains('hidden')) return;
                hardDrop();
                createAudio('button');
            });
            buttonB.addEventListener('click', () => {
                if (!document.getElementById('tetrisScreen').classList.contains('hidden')) {
                    // Go back home
                    document.getElementById('homeScreen').classList.remove('hidden');
                    document.getElementById('tetrisScreen').classList.add('hidden');
                    createAudio('button');
                }
            });
        });
    </script>
</body>
</html>

